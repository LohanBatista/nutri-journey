generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  professionals Professional[]
  patients     Patient[]
  programs     Program[]
  subscriptions OrganizationSubscription[]
}

model Professional {
  id                  String   @id @default(uuid())
  name                String
  email               String   @unique
  passwordHash        String
  role                String   @default("PROFESSIONAL") // "ADMIN" | "PROFESSIONAL"
  organizationId      String
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  consultations       Consultation[]
  anthropometryRecords AnthropometryRecord[]
  labResults          LabResult[]
  nutritionPlans      NutritionPlan[]
  nutritionGeneralGuidances NutritionGeneralGuidance[]
  programProfessionals ProgramProfessional[]
  aiSummaries         AiSummary[]
  aiNutritionDiagnosisSuggestions AiNutritionDiagnosisSuggestion[] @relation("ProfessionalNutritionDiagnoses")
  tasks               Task[]
}

model Patient {
  id             String   @id @default(uuid())
  fullName       String
  dateOfBirth    DateTime
  sex            String   // "MALE" | "FEMALE" | "OTHER"
  email          String?
  phone          String?
  tags           String[] @default([])
  notes          String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  consultations  Consultation[]
  anthropometryRecords AnthropometryRecord[]
  labResults     LabResult[]
  nutritionPlans NutritionPlan[]
  nutritionGeneralGuidances NutritionGeneralGuidance[]
  programParticipants ProgramParticipant[]
  programMeetingRecords ProgramMeetingRecord[]
  aiSummaries      AiSummary[]
  aiNutritionDiagnosisSuggestions AiNutritionDiagnosisSuggestion[] @relation("PatientNutritionDiagnoses")
  aiEducationMaterials AiEducationMaterial[] @relation("PatientEducationMaterials")
  tasks            Task[]
}

model Consultation {
  id                String   @id @default(uuid())
  organizationId    String
  patientId         String
  patient           Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId    String
  professional      Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  dateTime          DateTime
  type              String   // "INITIAL" | "FOLLOW_UP" | "GROUP" | "HOSPITAL"
  mainComplaint     String?
  nutritionHistory  String?
  clinicalHistory   String?
  objectiveData     String?
  nutritionDiagnosis String?
  plan              String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  aiNutritionDiagnosisSuggestions AiNutritionDiagnosisSuggestion[]
}

model AnthropometryRecord {
  id                  String   @id @default(uuid())
  organizationId      String
  patientId           String
  patient             Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId      String
  professional        Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  date                DateTime
  weightKg            Float?
  heightM             Float?
  bmi                 Float?
  waistCircumference  Float?
  hipCircumference    Float?
  armCircumference    Float?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model LabResult {
  id              String   @id @default(uuid())
  organizationId  String
  patientId       String
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId  String
  professional    Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  date            DateTime
  testType        String   // "GLYCEMIA" | "HBA1C" | "CT" | "HDL" | "LDL" | "TG" | "OTHER"
  name            String
  value           String   // Armazenado como string para suportar n√∫meros e strings
  unit            String
  referenceRange  String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model NutritionPlan {
  id            String   @id @default(uuid())
  organizationId String
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId String
  professional  Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  title         String
  goals         String
  notes         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  meals         NutritionPlanMeal[]
}

model NutritionPlanMeal {
  id              String   @id @default(uuid())
  nutritionPlanId String
  nutritionPlan  NutritionPlan @relation(fields: [nutritionPlanId], references: [id], onDelete: Cascade)
  mealType        String   // "BREAKFAST" | "MORNING_SNACK" | "LUNCH" | "AFTERNOON_SNACK" | "DINNER" | "SUPPER" | "OTHER"
  description     String
  observation     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model NutritionGeneralGuidance {
  id                        String   @id @default(uuid())
  organizationId            String
  patientId                 String
  patient                   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId            String
  professional              Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  date                      DateTime
  hydrationGuidance         String?
  physicalActivityGuidance  String?
  sleepGuidance             String?
  symptomManagementGuidance String?
  notes                     String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model Program {
  id            String   @id @default(uuid())
  organizationId String
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name          String
  description   String
  startDate     DateTime?
  endDate       DateTime?
  status        String   @default("PLANNED") // "PLANNED" | "ACTIVE" | "FINISHED"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  professionals ProgramProfessional[]
  participants  ProgramParticipant[]
  meetings      ProgramMeeting[]
  aiEducationMaterials AiEducationMaterial[]
  aiProgramSummaries AiProgramSummary[]
  tasks        Task[]
}

model ProgramProfessional {
  id            String   @id @default(uuid())
  programId     String
  program       Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  professionalId String
  professional  Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  role          String   // "LEAD_NUTRITIONIST" | "NUTRITIONIST" | "OTHER"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([programId, professionalId])
}

model ProgramParticipant {
  id            String   @id @default(uuid())
  programId     String
  program       Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  joinDate      DateTime @default(now())
  leaveDate     DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([programId, patientId])
}

model ProgramMeeting {
  id            String   @id @default(uuid())
  programId     String
  program       Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  date          DateTime
  topic         String
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  records       ProgramMeetingRecord[]
  aiProgramSummaries AiProgramSummary[]
}

model ProgramMeetingRecord {
  id                    String   @id @default(uuid())
  programMeetingId      String
  programMeeting        ProgramMeeting @relation(fields: [programMeetingId], references: [id], onDelete: Cascade)
  patientId             String
  patient               Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  presence              Boolean  @default(false)
  weightKg              Float?
  bmi                   Float?
  bloodPressureSystolic Float?
  bloodPressureDiastolic Float?
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([programMeetingId, patientId])
}

model AiSummary {
  id                String   @id @default(uuid())
  organizationId    String
  patientId         String
  patient           Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId    String
  professional      Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  type              String   // "WEEKLY_OVERVIEW" | "FULL_HISTORY" | "PRE_CONSULT"
  periodStart       DateTime?
  periodEnd         DateTime?
  textForProfessional String @db.Text
  createdAt         DateTime @default(now())
}

model AiNutritionDiagnosisSuggestion {
  id              String   @id @default(uuid())
  organizationId  String
  patientId       String
  patient         Patient  @relation("PatientNutritionDiagnoses", fields: [patientId], references: [id], onDelete: Cascade)
  professionalId  String
  professional    Professional @relation("ProfessionalNutritionDiagnoses", fields: [professionalId], references: [id], onDelete: Cascade)
  consultationId  String?
  consultation    Consultation? @relation(fields: [consultationId], references: [id], onDelete: SetNull)
  diagnoses       String   @db.Text // JSON array serialized
  createdAt       DateTime @default(now())
}

model AiEducationMaterial {
  id              String   @id @default(uuid())
  organizationId  String
  patientId       String?
  patient         Patient? @relation("PatientEducationMaterials", fields: [patientId], references: [id], onDelete: Cascade)
  programId       String?
  program         Program? @relation(fields: [programId], references: [id], onDelete: Cascade)
  topic           String
  context         String   // "INDIVIDUAL" | "GROUP"
  text            String   @db.Text
  createdAt       DateTime @default(now())
}

model AiProgramSummary {
  id              String   @id @default(uuid())
  organizationId  String
  programId       String
  program         Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  type            String   // "MEETING_SUMMARY" | "PROGRAM_OVERVIEW"
  meetingId       String?
  meeting         ProgramMeeting? @relation(fields: [meetingId], references: [id], onDelete: SetNull)
  text            String   @db.Text
  createdAt       DateTime @default(now())
}

model Task {
  id            String   @id @default(uuid())
  organizationId String
  professionalId String
  professional  Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  patientId     String?
  patient       Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)
  programId     String?
  program       Program? @relation(fields: [programId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  dueDate       DateTime?
  status        String   @default("PENDING") // "PENDING" | "IN_PROGRESS" | "DONE"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId])
  @@index([professionalId])
  @@index([patientId])
  @@index([programId])
}

model Plan {
  id                String   @id @default(uuid())
  name              String
  description       String
  monthlyPriceCents Int
  maxProfessionals  Int?
  maxPatients       Int?
  createdAt         DateTime @default(now())
  subscriptions     OrganizationSubscription[]
}

model OrganizationSubscription {
  id            String   @id @default(uuid())
  organizationId String
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId        String
  plan          Plan     @relation(fields: [planId], references: [id], onDelete: Restrict)
  startDate     DateTime @default(now())
  endDate       DateTime?
  status        String   @default("TRIAL") // "ACTIVE" | "CANCELLED" | "TRIAL"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId])
  @@index([planId])
}

